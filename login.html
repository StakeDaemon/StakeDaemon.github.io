<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Solana Login Test</title>
</head>

<body style="background:#0d1117; color:white; font-family:monospace; padding:20px;">
  <h2>Solana Login Test</h2>

  <button id="connectWalletBtn" style="padding:10px 20px;">Connect Solana Wallet</button>
  <button id="loginBtn" style="padding:10px 20px; margin-left:10px;">Login with Solana</button>

  <h3>Logs:</h3>
  <pre id="logs" style="background:black; padding:15px; height:400px; overflow:auto;"></pre>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const log = (msg) => {
      const l = document.getElementById("logs");
      l.textContent += msg + "\n";
      l.scrollTop = l.scrollHeight;
    };

    // --- SUPABASE SETUP ---
    const supabase = createClient(
      "https://zgvluycfalorrgglyslf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpndmx1eWNmYWxvcnJnZ2x5c2xmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTM3MzcsImV4cCI6MjA3ODUyOTczN30.0SbpFSQUzm0BEsbIfaCsggW6iM1-qqG3UqexdntNzvw"
    );

    // --- GLOBAL STATE ---
    let walletAddress = null;

    // --- Connect Phantom Wallet ---
    document.getElementById("connectWalletBtn").onclick = async () => {
      try {
        const provider = window.phantom?.solana;
        if (!provider) {
          log("âŒ Phantom wallet not found!");
          return;
        }

        const resp = await provider.connect();
        walletAddress = resp.publicKey.toString();

        log("ðŸ”— Connected Wallet:");
        log(walletAddress);
      } catch (err) {
        log("âŒ Wallet Connect Error: " + err.message);
      }
    };

    // --- LOGIN WITH SOLANA via SUPABASE ---
    document.getElementById("loginBtn").onclick = async () => {
      if (!walletAddress) {
        log("âŒ Connect wallet first!");
        return;
      }

      log("ðŸ” Starting Supabase Sign-in with Solana...");

      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "solana",
        options: {
          redirectTo: "https://stakedaemon.github.io/login.html"
        }
      });

      if (error) log("âŒ Login Error: " + JSON.stringify(error));
      else log("âœ… Login request sent, waiting for redirect...");
    };

    // --- AFTER REDIRECT: CHECK SESSION ---
    const check = async () => {
      log("ðŸ” Checking session...");

      const { data, error } = await supabase.auth.getUser();

      if (error) {
        log("âŒ No session: " + error.message);
        return;
      }

      if (!data?.user) {
        log("âŒ No Supabase user found");
        return;
      }

      const user = data.user;
      log("ðŸŽ‰ Logged in as: " + user.id);

      // Now save wallet to DB
      saveWallet(user.id);
    };

    async function saveWallet(userId) {
      log("ðŸ’¾ Saving wallet to Supabase...");

      const { error } = await supabase
        .from("users")
        .upsert({
          id: userId,
          sol_wallet: walletAddress || "no-wallet"
        });

      if (error) log("âŒ DB Save Error: " + error.message);
      else log("âœ… Wallet saved successfully!");
    }

    // Trigger on every load
    check();

    // Listen login event
    supabase.auth.onAuthStateChange((event, session) => {
      log("âš¡ Auth Event: " + event);
      if (session) log("ðŸŸ© Session user: " + session.user.id);
    });
  </script>
</body>
</html>
